<!-- Porthole FAB Widget - Self-contained floating action button for nginx sub_filter injection -->
<div id="porthole-fab-container" class="porthole-fab-container">
    <div id="porthole-fab-tooltip" class="porthole-fab-tooltip">Return to portal ‚Ä¢ Right-click for options</div>
    <div id="porthole-fab-notification" class="porthole-fab-notification">URL copied to clipboard!</div>
    <div id="porthole-fab-context-menu" class="porthole-fab-context-menu">
        <div class="porthole-fab-context-item" onclick="portholeNavigateToPortal()">
            <span>üè†</span> Return to Portal
        </div>
        <div class="porthole-fab-context-item" onclick="portholeCopyCurrentUrl()">
            <span>üìã</span> Copy URL
        </div>
    </div>
    <button id="porthole-fab-button" class="porthole-fab">
        <div class="porthole-fab-icon"></div>
    </button>
</div>

<style>
/* Porthole FAB Widget Styles - Collision-resistant with porthole- prefixes */
.porthole-fab-container {
    position: fixed !important;
    bottom: 20px !important;
    left: 20px !important;
    z-index: 999999 !important;
    display: flex !important;
    flex-direction: column !important;
    align-items: center !important;
    gap: 8px !important;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif !important;
}

.porthole-fab {
    width: 56px !important;
    height: 56px !important;
    border-radius: 50% !important;
    background: linear-gradient(135deg, rgba(100, 181, 246, 0.9) 0%, rgba(100, 181, 246, 0.7) 100%) !important;
    border: 2px solid rgba(255, 255, 255, 0.2) !important;
    box-shadow: 0 4px 20px rgba(100, 181, 246, 0.3), 0 2px 8px rgba(0, 0, 0, 0.2) !important;
    backdrop-filter: blur(10px) !important;
    cursor: pointer !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
    user-select: none !important;
    -webkit-tap-highlight-color: transparent !important;
    padding: 0 !important;
    margin: 0 !important;
    outline: none !important;
}

.porthole-fab:hover {
    transform: translateY(-2px) scale(1.05) !important;
    background: linear-gradient(135deg, rgba(100, 181, 246, 1) 0%, rgba(100, 181, 246, 0.9) 100%) !important;
    box-shadow: 0 8px 30px rgba(100, 181, 246, 0.4), 0 4px 12px rgba(0, 0, 0, 0.3) !important;
    border-color: rgba(255, 255, 255, 0.3) !important;
}

.porthole-fab:active {
    transform: translateY(-1px) scale(1.02) !important;
    transition: all 0.1s ease !important;
}

.porthole-fab-icon {
    width: 28px !important;
    height: 28px !important;
    background-image: url('https://raw.githubusercontent.com/jessegoodier/porthole/main/src/porthole/static/porthole.png') !important;
    background-size: contain !important;
    background-repeat: no-repeat !important;
    background-position: center !important;
    filter: brightness(0) invert(1) !important;
    transition: all 0.3s ease !important;
}

.porthole-fab:hover .porthole-fab-icon {
    transform: rotate(5deg) scale(1.1) !important;
}

/* FAB Tooltip */
.porthole-fab-tooltip {
    position: absolute !important;
    bottom: 100% !important;
    left: 50% !important;
    transform: translateX(-50%) !important;
    background: rgba(45, 45, 45, 0.95) !important;
    color: #ffffff !important;
    padding: 8px 12px !important;
    border-radius: 8px !important;
    font-size: 0.8rem !important;
    font-weight: 500 !important;
    white-space: nowrap !important;
    backdrop-filter: blur(10px) !important;
    border: 1px solid rgba(255, 255, 255, 0.1) !important;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3) !important;
    opacity: 0 !important;
    visibility: hidden !important;
    transition: all 0.3s ease !important;
    pointer-events: none !important;
    margin-bottom: 8px !important;
    z-index: 999998 !important;
}

.porthole-fab-tooltip::after {
    content: '' !important;
    position: absolute !important;
    top: 100% !important;
    left: 50% !important;
    transform: translateX(-50%) !important;
    border: 6px solid transparent !important;
    border-top-color: rgba(45, 45, 45, 0.95) !important;
}

.porthole-fab-container:hover .porthole-fab-tooltip {
    opacity: 1 !important;
    visibility: visible !important;
    transform: translateX(-50%) translateY(-4px) !important;
}

/* Success notification */
.porthole-fab-notification {
    position: absolute !important;
    bottom: 100% !important;
    left: 50% !important;
    transform: translateX(-50%) !important;
    background: rgba(76, 175, 80, 0.95) !important;
    color: #ffffff !important;
    padding: 8px 12px !important;
    border-radius: 8px !important;
    font-size: 0.8rem !important;
    font-weight: 500 !important;
    white-space: nowrap !important;
    backdrop-filter: blur(10px) !important;
    border: 1px solid rgba(255, 255, 255, 0.1) !important;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3) !important;
    opacity: 0 !important;
    visibility: hidden !important;
    transition: all 0.3s ease !important;
    pointer-events: none !important;
    margin-bottom: 8px !important;
    z-index: 999997 !important;
}

.porthole-fab-notification.porthole-show {
    opacity: 1 !important;
    visibility: visible !important;
    transform: translateX(-50%) translateY(-4px) !important;
}

.porthole-fab-notification::after {
    content: '' !important;
    position: absolute !important;
    top: 100% !important;
    left: 50% !important;
    transform: translateX(-50%) !important;
    border: 6px solid transparent !important;
    border-top-color: rgba(76, 175, 80, 0.95) !important;
}

/* Context menu for secondary actions */
.porthole-fab-context-menu {
    position: absolute !important;
    bottom: 100% !important;
    left: 0 !important;
    background: rgba(45, 45, 45, 0.95) !important;
    border: 1px solid rgba(255, 255, 255, 0.2) !important;
    border-radius: 12px !important;
    padding: 8px 0 !important;
    backdrop-filter: blur(10px) !important;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3) !important;
    opacity: 0 !important;
    visibility: hidden !important;
    transform: translateY(10px) !important;
    transition: all 0.3s ease !important;
    pointer-events: none !important;
    margin-bottom: 8px !important;
    min-width: 160px !important;
    z-index: 999996 !important;
}

.porthole-fab-context-menu.porthole-show {
    opacity: 1 !important;
    visibility: visible !important;
    transform: translateY(0) !important;
    pointer-events: all !important;
}

.porthole-fab-context-item {
    padding: 10px 16px !important;
    color: #e0e0e0 !important;
    cursor: pointer !important;
    transition: background-color 0.2s ease !important;
    font-size: 0.85rem !important;
    display: flex !important;
    align-items: center !important;
    gap: 8px !important;
    margin: 0 !important;
    border: none !important;
    background: transparent !important;
}

.porthole-fab-context-item:hover {
    background: rgba(100, 181, 246, 0.2) !important;
    color: #ffffff !important;
}

.porthole-fab-context-item:first-child {
    border-radius: 8px 8px 0 0 !important;
}

.porthole-fab-context-item:last-child {
    border-radius: 0 0 8px 8px !important;
}

/* Mobile responsiveness for FAB */
@media (max-width: 768px) {
    .porthole-fab-container {
        bottom: 16px !important;
        left: 16px !important;
    }

    .porthole-fab {
        width: 52px !important;
        height: 52px !important;
    }

    .porthole-fab-icon {
        width: 24px !important;
        height: 24px !important;
    }

    .porthole-fab-tooltip,
    .porthole-fab-notification {
        font-size: 0.75rem !important;
        padding: 6px 10px !important;
    }

    .porthole-fab-context-menu {
        min-width: 140px !important;
    }

    .porthole-fab-context-item {
        padding: 8px 12px !important;
        font-size: 0.8rem !important;
    }
}

/* Pulse animation for first time users */
.porthole-fab.porthole-pulse {
    animation: porthole-fab-pulse 2s infinite !important;
}

@keyframes porthole-fab-pulse {
    0% {
        box-shadow: 0 4px 20px rgba(100, 181, 246, 0.3), 0 2px 8px rgba(0, 0, 0, 0.2) !important;
    }
    50% {
        box-shadow: 0 4px 20px rgba(100, 181, 246, 0.6), 0 2px 8px rgba(0, 0, 0, 0.2), 0 0 0 10px rgba(100, 181, 246, 0.1) !important;
    }
    100% {
        box-shadow: 0 4px 20px rgba(100, 181, 246, 0.3), 0 2px 8px rgba(0, 0, 0, 0.2) !important;
    }
}
</style>

<script>
(function() {
    'use strict';
    
    // Prevent duplicate FAB injection
    if (window.portholeExplorerInjected) {
        return;
    }
    window.portholeExplorerInjected = true;

    // Wait for DOM to be ready
    function portholeInitFAB() {
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', portholeInitFAB);
            return;
        }

        const fabButton = document.getElementById('porthole-fab-button');
        const fabContainer = document.getElementById('porthole-fab-container');
        const fabContextMenu = document.getElementById('porthole-fab-context-menu');
        const fabTooltip = document.getElementById('porthole-fab-tooltip');

        if (!fabButton || !fabContainer) return;

        // Handle left click - navigate to portal
        fabButton.addEventListener('click', function(event) {
            event.preventDefault();
            event.stopPropagation();
            portholeNavigateToPortal();
        });

        // Handle right click - show context menu
        fabButton.addEventListener('contextmenu', function(event) {
            event.preventDefault();
            event.stopPropagation();
            portholeShowContextMenu();
        });

        // Handle long press on mobile
        let pressTimer;
        fabButton.addEventListener('touchstart', function(event) {
            pressTimer = setTimeout(function() {
                event.preventDefault();
                portholeShowContextMenu();
            }, 500); // 500ms for long press
        });

        fabButton.addEventListener('touchend', function(event) {
            clearTimeout(pressTimer);
        });

        fabButton.addEventListener('touchmove', function(event) {
            clearTimeout(pressTimer);
        });

        // Close context menu when clicking outside
        document.addEventListener('click', function(event) {
            if (!fabContainer.contains(event.target)) {
                portholeHideContextMenu();
            }
        });

        // Add pulse animation for first-time users
        try {
            const hasSeenFAB = localStorage.getItem('porthole-fab-seen');
            if (!hasSeenFAB) {
                fabButton.classList.add('porthole-pulse');
                localStorage.setItem('porthole-fab-seen', 'true');
                
                // Remove pulse after 6 seconds
                setTimeout(() => {
                    fabButton.classList.remove('porthole-pulse');
                }, 6000);
            }
        } catch (e) {
            // localStorage might not be available, ignore
        }

        // Update tooltip based on current page
        portholeUpdateTooltip();
    }

    // Navigation function
    window.portholeNavigateToPortal = function() {
        // Extract portal host from current URL
        const currentHost = window.location.host;
        const protocol = window.location.protocol;
        
        // Navigate to portal root
        window.location.href = protocol + '//' + currentHost + '/';
    };

    // Copy URL function
    window.portholeCopyCurrentUrl = function() {
        const currentUrl = window.location.href;
        
        // Try modern Clipboard API first
        if (navigator.clipboard && window.isSecureContext) {
            navigator.clipboard.writeText(currentUrl).then(function() {
                portholeShowNotification('URL copied to clipboard!');
            }).catch(function(err) {
                console.error('Failed to copy using Clipboard API:', err);
                portholeFallbackCopy(currentUrl);
            });
        } else {
            // Fallback for older browsers
            portholeFallbackCopy(currentUrl);
        }
    };

    // Fallback copy function
    function portholeFallbackCopy(text) {
        // Create temporary textarea element
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed';
        textArea.style.left = '-9999px';
        textArea.style.top = '-9999px';
        document.body.appendChild(textArea);
        
        try {
            textArea.focus();
            textArea.select();
            const successful = document.execCommand('copy');
            if (successful) {
                portholeShowNotification('URL copied to clipboard!');
            } else {
                portholeShowNotification('Copy failed - please copy manually', true);
            }
        } catch (err) {
            console.error('Fallback copy failed:', err);
            portholeShowNotification('Copy not supported - please copy manually', true);
        } finally {
            document.body.removeChild(textArea);
        }
    }

    // Show context menu
    function portholeShowContextMenu() {
        const fabContextMenu = document.getElementById('porthole-fab-context-menu');
        const fabTooltip = document.getElementById('porthole-fab-tooltip');
        
        if (!fabContextMenu) return;
        
        // Hide tooltip when showing context menu
        if (fabTooltip) {
            fabTooltip.style.opacity = '0';
            fabTooltip.style.visibility = 'hidden';
        }
        
        // Show context menu
        fabContextMenu.classList.add('porthole-show');
        
        // Auto-hide after 5 seconds
        setTimeout(() => {
            portholeHideContextMenu();
        }, 5000);
    }

    // Hide context menu
    function portholeHideContextMenu() {
        const fabContextMenu = document.getElementById('porthole-fab-context-menu');
        if (fabContextMenu) {
            fabContextMenu.classList.remove('porthole-show');
        }
    }

    // Show notification
    function portholeShowNotification(message, isError = false) {
        const fabNotification = document.getElementById('porthole-fab-notification');
        const fabTooltip = document.getElementById('porthole-fab-tooltip');
        
        if (!fabNotification) return;
        
        // Update message and style
        fabNotification.textContent = message;
        if (isError) {
            fabNotification.style.background = 'rgba(244, 67, 54, 0.95)';
            fabNotification.style.borderTopColor = 'rgba(244, 67, 54, 0.95)';
        } else {
            fabNotification.style.background = 'rgba(76, 175, 80, 0.95)';
            fabNotification.style.borderTopColor = 'rgba(76, 175, 80, 0.95)';
        }
        
        // Hide tooltip and context menu
        if (fabTooltip) {
            fabTooltip.style.opacity = '0';
            fabTooltip.style.visibility = 'hidden';
        }
        portholeHideContextMenu();
        
        // Show notification
        fabNotification.classList.add('porthole-show');
        
        // Auto-hide after 3 seconds
        setTimeout(() => {
            fabNotification.classList.remove('porthole-show');
            // Reset color after hiding
            setTimeout(() => {
                fabNotification.style.background = 'rgba(76, 175, 80, 0.95)';
                fabNotification.style.borderTopColor = 'rgba(76, 175, 80, 0.95)';
            }, 300);
        }, 3000);
    }

    // Update tooltip based on context
    function portholeUpdateTooltip() {
        const fabTooltip = document.getElementById('porthole-fab-tooltip');
        if (!fabTooltip) return;
        
        const currentPath = window.location.pathname;
        
        if (currentPath === '/' || currentPath === '') {
            fabTooltip.textContent = 'Portal home ‚Ä¢ Right-click for options';
        } else {
            fabTooltip.textContent = 'Return to portal ‚Ä¢ Right-click to copy URL';
        }
    }

    // Initialize FAB
    portholeInitFAB();
})();
</script>