# NGINX location blocks for Kubernetes services
# Generated at: {{ generated_at }}
# Total locations: {{ locations|length }}
# Add these inside your server block

{% for location in locations -%}
        location {{ location.path }} {
            set $base_path "{{ location.path }}";
            rewrite ^{{ location.path }}/?(.*)$ /$1 break;
            proxy_pass http://{{ location.service_dns }};

            # Porthole FAB injection configuration
            # Force decompression to enable sub_filter processing
            proxy_set_header Accept-Encoding "";
            
            # Enable response buffering for sub_filter
            proxy_buffering on;
            proxy_buffer_size 128k;
            proxy_buffers 4 256k;
            proxy_busy_buffers_size 256k;
            
            # Enable error interception for FAB on error pages
            proxy_intercept_errors on;
            error_page 404 502 503 504 =200 /porthole-error-fab;
            
            # Sub-filter configuration for FAB injection
            sub_filter_types text/plain application/json text/css application/javascript text/xml application/xml;
            sub_filter_once off;
            sub_filter_last_modified off;
            
            # Multiple injection strategies for maximum reliability
            # Strategy 1: Inject before closing body tag (most common)
            sub_filter '</body>' '{{ porthole_fab_widget }}</body>';
            
            # Strategy 2: Inject before closing html tag (backup)
            sub_filter '</html>' '{{ porthole_fab_widget }}</html>';
            
            # Strategy 3: Inject at end of any HTML content (fallback)
            sub_filter '</head>' '</head><!-- Porthole FAB container ready -->';

            # Handle redirects by returning the location header as plain text
            proxy_hide_header Location;
            add_header X-Original-Location $upstream_http_location;
            add_header X-Original-Status $upstream_status;
            
            # If it's a 302, return the location as the response body with FAB
            # TODO: This is a hack to handle redirects. We should find a better way to handle this.
            if ($upstream_status = 302) {
                return 200 '$upstream_http_location{{ porthole_fab_widget }}';
            }

            # Standard proxy headers
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Timeout settings
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
        }

{% endfor %}

# Error page location for FAB injection on upstream failures
location = /porthole-error-fab {
    internal;
    return 200 '<!DOCTYPE html>
<html>
<head>
    <title>Service Unavailable - Porthole</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            color: #e0e0e0;
            margin: 0;
            padding: 2rem;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .error-container {
            text-align: center;
            max-width: 500px;
            background: rgba(255, 255, 255, 0.05);
            padding: 2rem;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        h1 { color: #64b5f6; margin-bottom: 1rem; }
        p { margin-bottom: 1.5rem; line-height: 1.6; }
        .service-path { 
            color: #ff9800; 
            font-family: monospace; 
            background: rgba(255, 152, 0, 0.1);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="error-container">
        <h1>ðŸš¢ Service Temporarily Unavailable</h1>
        <p>The requested service at <span class="service-path">$request_uri</span> is currently unavailable.</p>
        <p>This could be due to:</p>
        <ul style="text-align: left; display: inline-block;">
            <li>Service is starting up</li>
            <li>Temporary network issues</li>
            <li>Service maintenance</li>
        </ul>
        <p>Please try again in a few moments, or return to the portal to explore other services.</p>
    </div>
    {{ porthole_fab_widget }}
</body>
</html>';
    add_header Content-Type text/html;
}